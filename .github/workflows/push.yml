---
name: push

on:
  push:
    branches:
      - '**'

jobs:
  # Build and test on Windows using Conan
  windows:
    strategy:
      matrix:
        name: [2022-64, 2022-32, 2019-64, 2019-32]
        include:
          - name: 2022-64
            build-profile: msvc-17-x86_64
            host-profile: msvc-17-x86_64
            runs-on: "windows-2022"
          - name: 2022-32
            build-profile: msvc-17-x86_64
            host-profile: msvc-17-x86
            runs-on: "windows-2022"
          - name: 2019-64
            build-profile: msvc-16-x86_64
            host-profile: msvc-16-x86_64
            runs-on: "windows-2019"
          - name: 2019-32
            build-profile: msvc-16-x86_64
            host-profile: msvc-16-x86
            runs-on: "windows-2019"
        build_type: ["Debug", "Release"]

    runs-on: ${{matrix.runs-on}}

    steps:
      - uses: actions/checkout@v2

      - name: Restore Dependency Cache
        uses: actions/cache@v2
        env:
          CACHE_SLUG: conan-windows-${{ matrix.name }}-${{ matrix.build_type }}
        with:
          path: |
            ~\AppData\Local\pip\Cache
            ~\.conan\data
          key: ${{ env.CACHE_SLUG }}-${{ github.ref_name }}-${{ hashFiles('conanfile.py','.github/conan/**','test/toolchain/**') }}
          restore-keys: |
            ${{ env.CACHE_SLUG }}-main-
            ${{ env.CACHE_SLUG }}-${{ github.ref_name }}-
            ${{ env.CACHE_SLUG }}-

      - name: Install Conan
        run: |
          pip.exe install conan;

      - name: Cache Report
        run: |
          conan search

      - name: Create build directory
        run: mkdir ${{runner.workspace}}\build

      - name: Install dependencies
        working-directory: ${{runner.workspace}}/build
        run: |
          conan install `
            --build=missing `
            --profile:build $env:GITHUB_WORKSPACE/.github/conan/profiles/${{matrix.build-profile}} `
            --profile:host $env:GITHUB_WORKSPACE/.github/conan/profiles/${{matrix.host-profile}} `
            --settings:host build_type="${{matrix.build_type}}" `
            $env:GITHUB_WORKSPACE

      - name: Build and run tests
        working-directory: ${{runner.workspace}}/build
        run: conan build --build --configure --test $env:GITHUB_WORKSPACE

      - name: Run benchmarks
        working-directory: ${{runner.workspace}}/build
        run: test\benchmark\${{matrix.build_type}}\test-benchmark.exe

      - name: Cache Report
        run: |
          conan search
...
